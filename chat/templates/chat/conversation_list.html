{% extends "chat/base.html" %}
{% block title %}Your Conversations{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    <!-- Left column: Conversation list -->
    <div class="w-1/3 bg-white overflow-y-auto border-r">
        <h1 class="text-2xl font-bold p-4 border-b">Your Conversations</h1>
        {% if conversations %}
            <ul>
            {% for conversation in conversations %}
                <li class="border-b hover:bg-gray-50">
                    <a href="#" class="flex items-center p-4 conversation-link" data-room-id="{{ conversation.id }}">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                            {{ conversation.participants.all|first|slice:":1"|upper }}
                        </div>
                        <div class="flex-grow">
                            <span class="font-semibold">
                                {% for participant in conversation.participants.all %}
                                    {% if participant != request.user %}
                                        {{ participant.username }}
                                    {% endif %}
                                {% endfor %}
                            </span>
                            <p class="text-sm text-gray-500 truncate">
                                {% if conversation.messages.last %}
                                    {{ conversation.messages.last.content|truncatechars:30 }}
                                {% else %}
                                    No messages yet
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-xs text-gray-400">
                            {% if conversation.messages.last %}
                                {{ conversation.messages.last.timestamp|date:"M d, Y" }}
                            {% endif %}
                        </div>
                    </a>
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <p class="p-4 text-gray-500">You don't have any conversations yet.</p>
        {% endif %}
    </div>

    <!-- Right column: Chat room -->
    <div class="w-2/3 flex flex-col">
        <div id="chat-room" class="flex-grow overflow-y-auto p-4">
            <!-- Chat messages will be loaded here -->
            <p class="text-center text-gray-500 mt-8">Select a conversation to start chatting</p>
        </div>
        <div class="border-t p-4">
            <form id="chat-form" class="flex">
                <input type="text" id="chat-input" class="flex-grow mr-2 p-2 border rounded" placeholder="Type a message..." disabled>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" disabled>Send</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatRoom = document.getElementById('chat-room');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const conversationLinks = document.querySelectorAll('.conversation-link');
    let currentRoomId = null;
    let chatSocket = null;

    conversationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const roomId = this.dataset.roomId;
            loadChatRoom(roomId);
        });
    });

    function loadChatRoom(roomId) {
        if (chatSocket) {
            chatSocket.close();
        }

        currentRoomId = roomId;
        chatRoom.innerHTML = '<p class="text-center">Loading messages...</p>';
        chatInput.disabled = false;
        chatForm.querySelector('button').disabled = false;

        fetch(`/chat/${roomId}/messages/`)
            .then(response => response.json())
            .then(messages => {
                chatRoom.innerHTML = '';
                messages.forEach(addMessageToChat);
                chatRoom.scrollTop = chatRoom.scrollHeight;

                chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${roomId}/`);

                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    addMessageToChat(data);
                    chatRoom.scrollTop = chatRoom.scrollHeight;
                };

                chatSocket.onclose = function(e) {
                    console.error('Chat socket closed unexpectedly');
                };
            });
    }

    function addMessageToChat(message) {
        const messageElement = document.createElement('div');
        messageElement.className = `mb-4 ${message.sender === '{{ request.user.username }}' ? 'text-right' : 'text-left'}`;
        messageElement.innerHTML = `
            <div class="inline-block bg-gray-200 rounded px-4 py-2 max-w-xs lg:max-w-md">
                <p class="font-semibold">${message.sender}</p>
                <p>${message.content}</p>
                <p class="text-xs text-gray-500 mt-1">${new Date(message.timestamp).toLocaleString()}</p>
            </div>
        `;
        chatRoom.appendChild(messageElement);
    }

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (chatInput.value.trim() && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': chatInput.value
            }));
            chatInput.value = '';
        }
    });
});
</script>
{% endblock %}